$(function () {
  $('#id_description_upload').fadeOut(0);
 /* var counter = function () {
    var txt = this.value;
    var re = /(^[6-9][0-9]{9}$)/gm;
    var num = txt.match(re);process_compose
    num = ((num && num.length) ? num = num.length : 0);
    $("#NumberCount").text(num);
  };*/
  var counter = function () {
    var txt = $(this).val(); 
    var re = /\b([6-9]\d{9})\b/g; 
    var numbers = txt.match(re); 
    
    var totalCount = 0;
    var uniqueNumbers = new Set();
    if (numbers) {
      totalCount = numbers.length;
      numbers.forEach(function(num) {
        uniqueNumbers.add(num);
      });
    }
    $("#NumberCount").text(totalCount); 
    $(".NumberCount").text(totalCount); 
    $("#UniqueNumberCount").text(uniqueNumbers.size); // Unique count
  };

  var th_chars = null;
  char_counter = function (e) {
    if(th_chars){
      clearTimeout(th_chars);
      th_chars = null;
    }

    var box = this;
    var msg = box.value;
    var data = {'msg': msg};

    th_chars = setTimeout(function(){
      $.getJSON('blocks/sms-stat.php', data, function(resp){
        if(resp.status === 'error'){
          $('#char-counter').val('');
          swal('Error',resp.message,'error');
        }else{
          $('#previewSms').html('')
          $("#charCount").text(resp.chars+" Chars");
          $("#SMSCount").text(resp.pdu+" SMS");
          $('#btn_msg_type').removeClass('hide').text(resp.type);
          $('#message_type').val(resp.type);
          if(resp.type == "Unicode"){
            $('#previewSms').html('<a class="btn btn-sm btn-danger blinking-text" id="view-sms-stat"><i class="glyph-icon icon-eye"></i></a>');
          }
        }
      }).fail(function(){
        swal('Error','Unable to proccess sms content','error');
      });
    }, 500);
  };

  characher_counter = function (e) {
    e.preventDefault();
    e.stopPropagation();
    var gearl = $("#char-counter").val();
    var shanicia = $("#char-counter").val().length;
  };

  $("#mobile-number-counter").on('input',counter);
  $("#char-counter").on('input',char_counter);
  $(".sms-message-counter").on('input',characher_counter);

  $("#mobile-number-counter").on('foucs',counter);
  $("#char-counter").on('focus',char_counter);
  $(".sms-message-counter").on('focus',characher_counter);

  $("#mobile-number-counter").on('blur',counter);
  $("#char-counter").on('blur',char_counter);
  $(".sms-message-counter").on('blur',characher_counter);

  $(document).on('click', '#view-sms-stat', function(e) {
    e.preventDefault();
    var msg = $('#char-counter').val();
    var data = {'mode': 'msg-preview','msg': msg};
    $.getJSON('blocks/sms-stat.php', data, function(resp){
      if(resp.status === 'success'){
        swal({
          title: '',
          html: true,
          text:
          `Below highlighted content is unicode, Please review. <br><br>\
          <div class="">\
                    ${resp.msg}
              </div>`
        });
        
      }
    }).fail(function(){
      swal('Error','Unable to proccess sms content','error');
    });
});

  $(document).on('click', '.download-jobs', function(e) {
    // alert();debugger;
    e.preventDefault();
    e.stopPropagation();
      var jobId = $(this).data('id');
      var data = 'JobID=' + jobId;

      var dateRange = $(this).data('date');
      if(dateRange != ''){
        data=data + '&date_range=' + dateRange;
      }

      var my = $(this).data('my');
      if(my != ''){
        data=data + '&MonthYear=' + my;
      }

      swal({
        'title': 'Generate report',
          text: 'You will receive alert on notification area with download link. This might take time depending upon report data.',
          type: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#00a792',
          confirmButtonText: 'Yes, make report',
          cancelButtonText: 'No, cancel it',
          closeOnConfirm: false,
          closeOnCancel: true
      }, function(choice){
        if(!choice) return;
        show_wip();
        $.get('download-job-details.php', data, function(){});
        setTimeout(function(){
          location.href = 'users-notice.php';
        }, 2000);
      });
      return false;
    });

    $('#split_sms').on('change', function(e){
      $('#SplitSMS').toggle(this.checked);
  });
  $('#process_compose').on('click', function(e){
      processCompose();
  });

  function processCompose(){
    $("#ComposeSMSMessage").fadeIn(0);
    swal({title: "Please wait ...", text: "System is processing your request. Please do not close or refresh browser.", showConfirmButton: false});
  
      var frm = new FormData(document.ComposeForm);
      frm.append('cmd','send-sms');
      var txt = $('#mobile-number-counter').val();
      if($.trim(txt).length){
        frm.append('numbers', new File([new Blob([txt], { type: 'text/plain' })], "copy-paste.txt", {type: "text/plain"}));
      }
      var numberCount = $('#NumberCount').text();
      var uniqueNumberCount = $('#UniqueNumberCount').text();
      var totalNumberCount = $('#TotalNumberCount').text();
      
      frm.append('NumberCount', numberCount);
      frm.append('UniqueNumberCount', uniqueNumberCount);
      frm.append('TotalNumberCount', totalNumberCount);
  
      $.ajax({
        url: this_page,
        data: frm,
        cache: false,
        contentType: false,
        processData: false,
        method: 'POST',
        cache: false,
        success: function(resp){
            // resp = JSON.parse(resp);
            swal('Job Status', resp.message, resp.status);
            if('success' === resp.status)
            {
              // swal('Success', resp.message, 'success');
              swal({
                title: 'Success',
                text: resp.message,
                icon: 'success',
                showConfirmButton: false
              });
              setTimeout(function() {
                window.location.href = "todays-report.php";
              }, 5000);
            }else{
              swal('Error', resp.message, 'error');
            }
        },
        error: function(){
              swal('Error', 'Something went wrong', 'error');
        }
      });
  }

  $('#contact_file').change(function() {
    if (!this.files || !this.files[0]) return;
    show_wip();
            var formData = new FormData();
        formData.append('contact_file', this.files[0]);
        formData.append('action','file-count');
        var task = function(){
          $.ajax({
              url: this_page, 
              type: 'POST',
              data: formData,
              async: false,
              cache: false,
              contentType: false,
              processData: false,
              success: function(response) {
              
                  if(response.status == 'success' && response.flag == 1){
                    $('#UniqueNumberCount, #TotalNumberCount').html('');
                    $('#UniqueNumberCount').html(response.unique);
                    $('#TotalNumberCount').html(response.total);
                  }else{
                    alert(response.message);
                  }
                  
              },
              error: function(jqXHR, textStatus, errorThrown) {
                  console.log('Error:', errorThrown);
              },
              complete : function(){
                swal.close();
              }
          });
        };
      setTimeout(task, 1000);
  });

    
});

